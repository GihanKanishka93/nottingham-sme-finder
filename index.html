<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nottingham SME Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <div class="shell">
      <div class="card">
        <h1>Nottingham SME Finder</h1>
        <p class="muted">Lists active companies in Nottingham from Companies House. Filter by SIC, company type, and incorporation dates. Export to CSV.</p>
        <div class="grid" style="margin-top:16px;">
          <aside>
            <div class="toolbar">
              <div style="flex:1 1 100%">
                <label>Location</label>
                <input id="location" value="Nottingham" />
              </div>
              <div>
                <label>Status</label>
                <select id="status">
                  <option value="active" selected>active</option>
                  <option value="dissolved">dissolved</option>
                </select>
              </div>
              <div style="flex:1 0 100%">
                <label>SIC codes (comma separated)</label>
                <input id="sic" placeholder="eg 62012,73110" />
              </div>
              <div style="flex:1 0 100%">
                <label>Company types (comma separated)</label>
                <input id="types" placeholder="eg ltd,private-limited-guarant-nsc" />
              </div>
              <div>
                <label>Incorporated from (YYYY-MM-DD)</label>
                <input id="from" placeholder="2020-01-01" />
              </div>
              <div>
                <label>Incorporated to (YYYY-MM-DD)</label>
                <input id="to" placeholder="2025-12-31" />
              </div>
              <div>
                <label>Results per page</label>
                <input id="size" type="number" min="1" max="5000" value="100" />
              </div>
              <div>
                <button id="prev">Previous</button>
                <button id="next">Next</button>
              </div>
              <div>
                <button id="search">Search</button>
                <button id="export">Export CSV</button>
              </div>
            </div>
          </aside>
          <main>
            <div id="summary" class="muted" style="margin-bottom:12px"></div>
            <div class="row">
              <table id="results">
                <thead>
                  <tr>
                    <th data-key="company_name">Company name</th>
                    <th data-key="company_number">Number</th>
                    <th data-key="company_status">Status</th>
                    <th data-key="date_of_creation">Incorporated</th>
                    <th data-key="address">Address</th>
                    <th data-key="sic_codes">SIC</th>
                  </tr>
                  <tr class="filters">
                    <th><input data-key="company_name" /></th>
                    <th><input data-key="company_number" /></th>
                    <th><input data-key="company_status" /></th>
                    <th><input data-key="date_of_creation" /></th>
                    <th><input data-key="address" /></th>
                    <th><input data-key="sic_codes" /></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </main>
        </div>
      </div>
    </div>

    <script>
      const qs = id => document.getElementById(id);
      const tbody = document.querySelector('#results tbody');
      const summary = qs('summary');
      const tableHeaders = document.querySelectorAll('#results thead th[data-key]');
      const filterInputs = document.querySelectorAll('#results thead tr.filters input');

      const filters = {};
      let sortState = { key: null, asc: true };
      let startIndex = 0;

      function fmt(v){ return v || ''; }
      function csvEscape(v){
        const s = String(v ?? '');
        if (s.includes(',') || s.includes('"') || s.includes('\n')) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      }

      const accessors = {
        company_name: it => fmt(it.company_name),
        company_number: it => fmt(it.company_number),
        company_status: it => fmt(it.company_status),
        date_of_creation: it => fmt(it.date_of_creation),
        address: it => {
          const addr = it.registered_office_address || {};
          return [addr.address_line_1, addr.address_line_2, addr.locality, addr.region, addr.postal_code, addr.country].filter(Boolean).join(', ');
        },
        sic_codes: it => (it.sic_codes || []).join(', ')
      };

      function render(){
        const baseRows = window.__lastRows || [];
        let rows = baseRows.filter(it => {
          return Object.entries(filters).every(([key, val]) => {
            if (!val) return true;
            return accessors[key](it).toLowerCase().includes(val);
          });
        });

        if (sortState.key){
          const dir = sortState.asc ? 1 : -1;
          rows = rows.slice().sort((a, b) => {
            const va = accessors[sortState.key](a).toLowerCase();
            const vb = accessors[sortState.key](b).toLowerCase();
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
          });
        }

        tbody.innerHTML = '';
        rows.forEach(it => {
          const tr = document.createElement('tr');
          const address = accessors.address(it);
          tr.innerHTML = `
            <td><a href="https://find-and-update.company-information.service.gov.uk/company/${fmt(it.company_number)}" target="_blank" rel="noopener">${fmt(it.company_name)}</a></td>
            <td>${fmt(it.company_number)}</td>
            <td>${fmt(it.company_status)}</td>
            <td>${fmt(it.date_of_creation)}</td>
            <td>${address}</td>
            <td>${accessors.sic_codes(it)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function run(){
        const params = new URLSearchParams({
          location: qs('location').value.trim(),
          status: qs('status').value,
          sic: qs('sic').value.trim(),
          types: qs('types').value.trim(),
          incorporated_from: qs('from').value.trim(),
          incorporated_to: qs('to').value.trim(),
          size: qs('size').value,
          start_index: startIndex
        });
        summary.textContent = 'Loadingâ€¦';
        const res = await fetch('/api/companies?' + params.toString());
        if (!res.ok){
          const t = await res.text();
          summary.textContent = 'Error: ' + t;
          window.__lastRows = [];
          render();
          updateNavButtons();
          return;
        }
        const data = await res.json();
        window.__lastRows = data.items || [];
        summary.textContent = `${window.__lastRows.length} results. Top hit is included separately in API, results show page slice. Total hits (if provided): ${data.hits ?? 'n/a'}`;
        render();
        updateNavButtons();
      }

      function exportCSV(){
        const rows = window.__lastRows || [];
        const headers = ['company_name','company_number','company_status','date_of_creation','address','sic_codes'];
        const lines = [headers.join(',')];
        rows.forEach(it => {
          const addr = it.registered_office_address || {};
          const address = [addr.address_line_1, addr.address_line_2, addr.locality, addr.region, addr.postal_code, addr.country].filter(Boolean).join(', ');
          lines.push([
            csvEscape(it.company_name),
            csvEscape(it.company_number),
            csvEscape(it.company_status),
            csvEscape(it.date_of_creation),
            csvEscape(address),
            csvEscape((it.sic_codes || []).join(' '))
          ].join(','));
        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nottingham_companies.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      tableHeaders.forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (sortState.key === key){
            sortState.asc = !sortState.asc;
          } else {
            sortState.key = key;
            sortState.asc = true;
          }
          render();
        });
      });

      filterInputs.forEach(inp => {
        inp.addEventListener('input', () => {
          filters[inp.dataset.key] = inp.value.trim().toLowerCase();
          render();
        });
      });

      function updateNavButtons(){
        const size = Number(qs('size').value);
        qs('prev').disabled = startIndex === 0;
        qs('next').disabled = (window.__lastRows || []).length < size;
      }

      qs('search').addEventListener('click', () => {
        startIndex = 0;
        run();
      });
      qs('prev').addEventListener('click', () => {
        const size = Number(qs('size').value);
        startIndex = Math.max(0, startIndex - size);
        run();
      });
      qs('next').addEventListener('click', () => {
        const size = Number(qs('size').value);
        startIndex += size;
        run();
      });
      qs('export').addEventListener('click', exportCSV);
      updateNavButtons();
      run();
    </script>
  </body>
</html>
